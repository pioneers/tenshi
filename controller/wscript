#!/usr/bin/env python

ARM_CROSS_COMPILER_C = 'arm-none-eabi-gcc'
ARM_CROSS_COMPILER_CXX = 'arm-none-eabi-g++'

import os.path
from waf_extensions import declare_variants, sub_conf, run_all
declare_variants(['deb', 'rel', 'debopt', 'relopt'], subdir='controller')


def recurse(ctxt):
    ctxt.recurse('vm', mandatory=False)


def options(opt):
    recurse(opt)
    opt.load('compiler_c')
    opt.load('compiler_cxx')
    opt.load('gas')

# Configure fragments used for variants


def common_configure(conf, root=None):
    if root is None:
        root = conf.path.abspath()
    conf.env['CC'] = ARM_CROSS_COMPILER_C
    conf.env['CC_NAME'] = ARM_CROSS_COMPILER_C
    conf.env['COMPILER_CC'] = ARM_CROSS_COMPILER_C
    conf.env['LINK_CC'] = ARM_CROSS_COMPILER_C
    conf.env['CXX'] = ARM_CROSS_COMPILER_CXX
    conf.env['CXX_NAME'] = ARM_CROSS_COMPILER_CXX
    conf.env['COMPILER_CXX'] = ARM_CROSS_COMPILER_CXX
    conf.env['LINK_CXX'] = ARM_CROSS_COMPILER_CXX
    conf.env['AS'] = ARM_CROSS_COMPILER_C
    conf.env.append_value('CFLAGS', [
        '-g',                       # Debug symbols
        '-Wall',                    # All warnings
        '-mthumb',                  # Cortex-M4 only supports Thumb
        '-mcpu=cortex-m4',          # Compile for Cortex-M4
        '-mfpu=fpv4-sp-d16',        # Enable FPU opcodes
        '-mfloat-abi=hard',         # Pass arguments via FPU registers
        '-fshort-double',           # sizeof(double) == sizeof(float)
        '-ffunction-sections',      # Each function in individual section
        '-fdata-sections',          # Same for data
        '-std=gnu99',               # C code is gnu99 standard
        ])
    conf.env.append_value('CXXFLAGS', [
        '-g',                       # Debug symbols
        '-Wall',                    # All warnings
        '-mthumb',                  # Cortex-M4 only supports Thumb
        '-mcpu=cortex-m4',          # Compile for Cortex-M4
        '-mfpu=fpv4-sp-d16',        # Enable FPU opcodes
        '-mfloat-abi=hard',         # Pass arguments via FPU registers
        '-fshort-double',           # sizeof(double) == sizeof(float)
        '-ffunction-sections',      # Each function in individual section
        '-fdata-sections',          # Same for data
        '-std=gnu++98',             # C++ code is gnu++98 standard
        ])
    conf.env.append_value('ASFLAGS', [
        '-g',                        # Debug symbols
        '-mthumb',                   # Cortex-M4 only supports Thumb
        '-mcpu=cortex-m4',           # Compile for Cortex-M4
        '-mfpu=fpv4-sp-d16',         # Enable FPU opcodes
        '-mfloat-abi=hard',          # Pass arguments via FPU registers
        '-x', 'assembler-with-cpp',  # Compile assembly
        '-c',                        # Don't link
        ])
    conf.env.append_value('LINKFLAGS', [
        '-g',                         # Debug symbols
        '-mthumb',                    # Cortex-M4 only supports Thumb
        '-mcpu=cortex-m4',            # Compile for Cortex-M4
        '-mfpu=fpv4-sp-d16',          # Enable FPU opcodes
        '-mfloat-abi=hard',           # Pass arguments via FPU registers
        '-Wl,--gc-sections',          # Discard unused sections
        '-Wl,-uVERSION_INFORMATION',  # Force retain VERSION_INFORMATION
        '-B' + root,                  # For finding .ld file
        # Linker rules + crt0
        '-specs=' + root + '/linkspec.specs',
        ])
    conf.load('compiler_c')
    conf.load('compiler_cxx')
    conf.load('gas')


def debug_configure(conf):
    conf.env.append_value('CFLAGS', ['-DDEBUG'])
    conf.env.append_value('CXXFLAGS', ['-DDEBUG'])
    conf.env.append_value('ASFLAGS', ['-DDEBUG'])


def release_configure(conf):
    conf.env.append_value('CFLAGS', ['-DRELEASE'])
    conf.env.append_value('CXXFLAGS', ['-DRELEASE'])
    conf.env.append_value('ASFLAGS', ['-DRELEASE'])


def noopt_configure(conf):
    conf.env.append_value('CFLAGS', ['-O0'])
    conf.env.append_value('CXXFLAGS', ['-O0'])
    conf.env.append_value('ASFLAGS', ['-O0'])


def opt_configure(conf):
    conf.env.append_value('CFLAGS', ['-O2'])
    conf.env.append_value('CXXFLAGS', ['-O2'])
    conf.env.append_value('ASFLAGS', ['-O2'])

# Actual configure rules for variants


def configure_deb(conf):
    with sub_conf(conf, 'controller/deb'):
        common_configure(conf)
        debug_configure(conf)
        noopt_configure(conf)
    with sub_conf(conf, 'controller/debopt'):
        common_configure(conf)
        debug_configure(conf)
        opt_configure(conf)


def configure_rel(conf):
    with sub_conf(conf, 'controller/rel'):
        common_configure(conf)
        release_configure(conf)
        noopt_configure(conf)
    with sub_conf(conf, 'controller/relopt'):
        common_configure(conf)
        release_configure(conf)
        opt_configure(conf)


def configure(conf):
    recurse(conf)
    configure_deb(conf)
    configure_rel(conf)

# Build step


from waflib import TaskGen
TaskGen.declare_chain(
    name='typpo',
    rule='../../../tools/typpo_c_generator.py ${SRC} ${TGT}',
    shell=False,
    ext_in='.yaml',
    ext_out='.h',
    reentrant=False,
)


def build(bld):
    recurse(bld)
    if not bld.variant:
        print('Building all variants.')
        run_all('build')
    else:
        if 'controller' not in bld.variant:
            return

        def bld_path(path):
            return bld.root.make_node(bld.variant_dir).make_node(path)

        def add_dependency(tgt, src):
            src_node = bld.path.find_resource(src)
            if src_node is None:
                bld.fatal("Could not find manual dependency '{}'".format(src))
            bld.add_manual_dependency(tgt, src_node)

        bld.objects(
            source="stm32f4-crt0.S",
            target="crt0",
        )

        bld(
            rule=bld.path.abspath() +
            '/../tools/inject-version-controller.py ${SRC} ${TGT}',
            source='src/version.c.template',
            target='version.c',
            always=True,
            update_outputs=True,
        )
        add_dependency('version.c', 'version.txt')

        bld.objects(
            source='version.c',
            target='version_obj',
            includes=". inc",
        )

        bld(
            name="typpo_includes",
            source=bld.path.parent.ant_glob("common_defs/*.yaml"),
            target="inc",
        )

        bld.objects(
            source=bld.path.ant_glob("src/**/*.c"),
            target="c_objects",
            includes=". inc ../common_defs",
            use="typpo_includes"
        )

        bld.objects(
            source=bld.path.ant_glob("src/**/*.cpp"),
            target="cpp_objects",
            includes=". inc ../common_defs",
            use="typpo_includes"
        )

        bld.program(
            source="",
            target=bld_path("tenshi.elf"),
            features="cxx cxxprogram",
            use="crt0 c_objects cpp_objects version_obj",
        )

        bld(
            rule='arm-none-eabi-objcopy -O binary ${SRC} ${TGT}',
            source=bld_path("tenshi.elf"),
            target=bld_path("tenshi.bin"),
        )

        add_dependency(bld_path("tenshi.elf"), "ldscript.ld")
        add_dependency(bld_path("tenshi.elf"), "linkspec.specs")
