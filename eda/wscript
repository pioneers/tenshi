#!/usr/bin/env python
from __future__ import print_function

import glob
import os.path
from waf_extensions import declare_variants, add_dependency

declare_variants(subdir='boards')


def have_pdftk():
    import subprocess
    if subprocess.call(['which', 'pdftk']) != 0:
        return False
    return True


def build(bld):
    if 'boards' not in bld.variant:
        return

    for board in glob.glob('eda/*.brd'):
        base_name = os.path.split(board)[-1]
        outfile = ('../../artifacts/boards/' +
                   os.path.splitext(base_name)[0] + '.zip')
        bld(rule='${root}/tools/run-eagle-cam-v2.py '
                 '${root}/tools/gerber_rules.yaml '
                 '${SRC} ${TGT}',
            source=base_name,
            target=outfile)

    for schematic in glob.glob('eda/*.sch'):
        base_name = os.path.split(schematic)[-1]
        outfile = ('../../artifacts/boards/' +
                   os.path.splitext(base_name)[0] + '.csv')
        bld(rule='${root}/tools/generate_bom.py ${SRC} ${TGT} '
                 '${root}/tools/parts-db.yaml',
            source=base_name,
            target=outfile)
        add_dependency(bld, outfile, '${root}/tools/parts-db.yaml')

    # HACK: If pdftk is not installed, don't generate documentation
    # packets (instead of failing the build)
    if not have_pdftk():
                print("""Warning: pdftk is not available.
Documentation packet PDFs will not be generated""")
    else:
        for schematic in glob.glob('eda/*.sch'):
            dir_name = os.path.dirname(schematic)
            base_name = os.path.basename(schematic)
            design_name = os.path.splitext(base_name)[0]

            sch_file = os.path.join(design_name + ".sch")
            csv_file = os.path.join("../../artifacts/boards/",
                                    design_name + ".csv")
            brd_file = os.path.join(design_name + ".brd")
            pdf_file = os.path.join("../../artifacts/boards/",
                                    design_name + ".pdf")

            if not os.path.isfile(os.path.join(dir_name, brd_file)):
                brd_file = None

            source = [f for f in [sch_file, csv_file, brd_file] if f is not None]

            bld(rule='${root}/tools/docu-packet-gen.py ${SRC} ${TGT}',
                source=source,
                target=pdf_file)
            add_dependency(bld, pdf_file, '${root}/tools/docu-packet-gen.py')
